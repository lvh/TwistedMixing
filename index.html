<?xml version="1.0" encoding="utf-8"?>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><title>(Twisted Mixing)</title>
<meta name="author" content="(Laurens Van Houtven)"/>
<link rel="stylesheet" href="./reveal.js/css/reveal.min.css">
    <link rel="stylesheet" href="./reveal.js/css/theme/simple.css" id="theme">
</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<h1>Twisted Mixing</h1>
<h2>Laurens Van Houtven</h2>
<h2><a href="mailto:@lvh">@lvh</a></h2>
<h2></h2></section>

<section>
<section>

<h2><span class="section-number-2">1</span> Introduction</h2>
</section>
<section>

<h3><span class="section-number-3">1.1</span> About me</h3>
<p>
Hi, I'm <code>lvh</code>.
</p>

<p>
I hack on and with Twisted.
</p>
</section>
<section>

<h3><span class="section-number-3">1.2</span> About this talk</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted code ↔ other code
</li>
<li class="fragment roll-in">Show that you probably <b>can</b> use Twisted
<ul class="org-ul">
<li>(Not so much that you <b>should</b> use Twisted)
</li>
</ul>
</li>
<li class="fragment roll-in">Overview
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">1.3</span> Why should you care?</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted has some cool stuff in and around it
<ul class="org-ul">
<li class="fragment roll-in">IRC, SMTP, DNS, SSH, WebSockets&#x2026;
</li>
<li class="fragment roll-in">Running multiple things in one process
</li>
<li class="fragment roll-in">Timed events, sane process and thread management
</li>
<li class="fragment roll-in">Protocol and transport abstractions
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Twisted vs other stuff: good at different things
<ul class="org-ul">
<li class="fragment roll-in">Many connections, particularly if relatively silent
<ul class="org-ul">
<li>Incoming, e.g. a chat server
</li>
<li>Outgoing, e.g. a scraper
</li>
</ul>
</li>
</ul>
<ul class="org-ul">
<li class="fragment roll-in">Cooperate with existing event loops
<ul class="org-ul">
<li>GUIs
</li>
<li>gevent
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">1.4</span> Prerequisites</h3>
<ul class="org-ul">
<li class="fragment roll-in">Ideally, just Python
</li>
<li class="fragment roll-in">Having played with Twisted probably helps
</li>
<li class="fragment roll-in">I will explain important concepts briefly
<ul class="org-ul">
<li>Please feel free to interrupt if I forget to
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">2</span> Introducing Twisted</h2>
</section>
<section>

<h3><span class="section-number-3">2.1</span> Reactor</h3>
<ul class="org-ul">
<li class="fragment roll-in">Object
<ul class="org-ul">
<li>Allows registration of new events
</li>
<li>Waits for those events
</li>
<li>Dispatches them when they occur
</li>
</ul>
</li>
<li class="fragment roll-in">Internally an event loop
<ul class="org-ul">
<li>Except for test reactors e.g. <code>Clock</code>
</li>
<li>Backed by some event mechanism
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">2.2</span> Reactor interfaces</h3>
<p>
Usually you call higher-level APIs!
</p>

<ul class="org-ul">
<li class="fragment roll-in"><code>IReactorBase</code>: <code>run</code>, <code>stop</code>&#x2026;
</li>
<li class="fragment roll-in"><code>IReactorTime</code>: <code>callLater</code>&#x2026;
</li>
<li class="fragment roll-in"><code>IReactorProcess</code>: <code>spawnProcess</code>
</li>
<li class="fragment roll-in"><code>IReactorThreads</code>: <code>callInThread</code>, <code>callFromThread</code>, &#x2026;
</li>
<li class="fragment roll-in"><code>IReactor(TCP|UDP|SSL|Multicast)</code>
</li>
<li class="fragment roll-in"><code>IReactor(UNIX|UNIXDatagram|Socket)</code>
</li>
<li class="fragment roll-in"><code>IReactorFDSet</code>: <code>(add|remove)(Reader|Writer)</code>, &#x2026;
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">2.3</span> Deferred</h3>
<p>
An object you get <b>now</b>,
</p>

<p>
gets you result or failure <b>later</b>
</p>
</section>
<section>

<h3><span class="section-number-3">2.4</span> Why deferreds?</h3>
<ul class="org-ul">
<li class="fragment roll-in">Many operations take time: <b>can't</b> get a result right now
</li>
<li class="fragment roll-in">Blocking API
<ul class="org-ul">
<li>Evaluate or raise some point in the future
</li>
<li>Thread can't do anything else in the mean while
</li>
</ul>
</li>
<li class="fragment roll-in">Deferred API
<ul class="org-ul">
<li>Get an object representing the future result <b>now</b>
</li>
<li>Actually give result (or failure) when it's available
</li>
<li>Thread is free to do something else
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">2.5</span> Deferred vs blocking API</h3>
<p>
Blocking read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = blocking_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>

<p>
Deferred read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #a0522d;">d</span> = async_read()
d.addCallbacks(on_result, on_failure)
</pre>
</div>
</section>
<section>

<h3><span class="section-number-3">2.6</span> Inline callbacks vs blocking API</h3>
<p>
Blocking read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = blocking_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>

<p>
<code>inlineCallbacks</code>: Deferreds + sugar
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = <span style="color: #7f007f;">yield</span> async_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">3</span> Twisted and your app</h2>
</section>
<section>

<h3><span class="section-number-3">3.1</span> Is there even a problem?</h3>
<p>
Maybe it's trivial to get started!
</p>
</section>
<section>

<h3><span class="section-number-3">3.2</span> SOA</h3>
<ul class="org-ul">
<li class="fragment roll-in">Service Oriented Architecture
<ul class="org-ul">
<li>"Loosely coupled things that talk to each other"
</li>
</ul>
</li>

<li class="fragment roll-in">Written in Gevent? Twisted? COBOL? Who cares!?
</li>
<li class="fragment roll-in">Work with Twisted, without touching existing code
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">3.3</span> WSGI</h3>
<ul class="org-ul">
<li class="fragment roll-in">How many of you have a WSGI application?
</li>
<li class="fragment roll-in">Twisted is a WSGI server:
<div class="org-src-container">

<pre class="src src-sh">twistd web --wsgi=location.of.wsgi.app
</pre>
</div>
</li>
<li class="fragment roll-in">Not a toy web server, can be used in production
</li>
<li class="fragment roll-in">Twisted does CGI too, but I hope <b>you</b> don't
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">3.4</span> Porting your app to Twisted</h3>
<ul class="org-ul">
<li class="fragment roll-in">No, it's not trivial
<ul class="org-ul">
<li>&#x2026; but cost is almost always overestimated
</li>
</ul>
</li>
<li class="fragment roll-in">Clean, tested code helps
<ul class="org-ul">
<li>Keep verifying behavior
</li>
<li>Tested code tends to be decoupled
</li>
</ul>
</li>
<li class="fragment roll-in">If it's near impossible, it's probably a code smell
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">3.5</span> Writing code that works on both</h3>
<ul class="org-ul">
<li>Not trivial, not hard either
</li>
<li>Example: <code>praekelt/vumi</code>
</li>
<li>TODO: more examples
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">3.6</span> Demo time!</h3>
<ul class="org-ul">
<li>Flask app, served by Twisted
</li>
<li>SockJS chat, also served by Twisted
</li>
</ul>

<p>
<a href="media/twistyflask-tox-run.mp4">media/twistyflask-tox-run.mp4</a>
</p>
</section>
<section>

<h3><span class="section-number-3">3.7</span> Demo notes</h3>
<ul class="org-ul">
<li><code>Klein</code>: Flask-like basic API, except Twisted by default
</li>
<li>Having data come from two sources is kind of dumb
<ul class="org-ul">
<li>&#x2026; but I had to have Flask do something :)
</li>
</ul>
</li>
<li>Quality!
<ul class="org-ul">
<li>No authentication, users are who they say they are
<ul class="org-ul">
<li>Duplicate usernames allowed
</li>
</ul>
</li>
<li>Protocol does dispatching + behavior
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">4</span> Blocking code in Twisted</h2>
</section>
<section>

<h3><span class="section-number-3">4.1</span> You can't block the reactor thread</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted is event-driven
<ul class="org-ul">
<li>Production reactors are just event loops
</li>
<li><code>select</code>, <code>epoll</code>, <code>kqueue</code>, IOCP, <code>libev(ent)</code>&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Reactor runs in a thread, calls everything else
<ul class="org-ul">
<li>One thing at a time, all in the same thread
</li>
<li>Concurrency through asynchronous IO
</li>
</ul>
</li>
<li class="fragment roll-in">Blocking the reactor thread means nothing else happens
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">4.2</span> Blocking in a callback is bad!</h3>
<p>
Blocking IO
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_getDataAtURL</span>(url):
    <span style="color: #7f007f;">return</span> requests.get(url).json() <span style="color: #b22222;"># </span><span style="color: #b22222;">BLOCKS!</span>
</pre>
</div>

<p>
Blocking computation
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_compute</span>(n):
    <span style="color: #a0522d;">x</span> = 2
    <span style="color: #7f007f;">for</span> _ <span style="color: #7f007f;">in</span> <span style="color: #483d8b;">xrange</span>(n): <span style="color: #b22222;"># </span><span style="color: #b22222;">BLOCKS! (for sufficiently large n)</span>
        <span style="color: #a0522d;">x</span> *= x
    send_somewhere(x)
</pre>
</div>
</section>
<section>

<h3><span class="section-number-3">4.3</span> Can't block the reactor thread!</h3>
<p>
Therefore, you have two options:
</p>

<ol class="org-ol">
<li>Don't block
</li>
<li>Block another thread
</li>
</ol>
</section>
<section>

<h3><span class="section-number-3">4.4</span> Don't block</h3>
<p>
IO bound? Be asynchronous!
</p>

<p>
CPU bound? Cooperate with the event loop!
</p>
</section>
<section>

<h3><span class="section-number-3">4.5</span> Asynchronous I/O version</h3>
<p>
<code>treq</code>: <code>requests</code>-like, but asynchronous
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_getDataAtURL</span>(url):
    <span style="color: #7f007f;">return</span> treq.get(url).addCallback(treq.json_content) <span style="color: #b22222;"># </span><span style="color: #b22222;">async :)</span>
</pre>
</div>
</section>
<section>

<h3><span class="section-number-3">4.6</span> Cooperative version</h3>
<p>
<code>twisted.internet.task.coiterate</code> and friends
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_compute</span>(n):
    <span style="color: #a0522d;">x</span> = 2
    <span style="color: #7f007f;">for</span> _ <span style="color: #7f007f;">in</span> <span style="color: #483d8b;">xrange</span>(n):
        <span style="color: #a0522d;">x</span> *= x
        <span style="color: #7f007f;">yield</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">Yields to the reactor :)</span>
    send_somewhere(x)

coiterate(_compute(n))
</pre>
</div>
</section>
<section>

<h3><span class="section-number-3">4.7</span> Don't block?</h3>
<p>
Avoiding blocking isn't always possible
</p>

<ul class="org-ul">
<li class="fragment roll-in">Blocking API
<ul class="org-ul">
<li><code>DBAPI2</code>, &#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Sometimes in C code you can't or don't want to mess with
<ul class="org-ul">
<li><code>scrypt</code>, &#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Sometimes at a kernel/syscall level
<ul class="org-ul">
<li>File IO, &#x2026;
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">4.8</span> Block somewhere else</h3>
<p>
Can't block the reactor thread → block a different one!
</p>

<ul class="org-ul">
<li class="fragment roll-in">&#x2026; in the same process: <code>deferToThread</code>
<ul class="org-ul">
<li>often used by wrappers: <code>adbapi</code>, <code>txscrypt</code>&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">&#x2026; in a child process: <code>spawnProcess</code> and friends
</li>
<li class="fragment roll-in">&#x2026; in a remote process: Ampoule, PB, Foolscap, RPC&#x2026;
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">4.9</span> deferToThread</h3>
<ul class="org-ul">
<li class="fragment roll-in">Easiest way to make things magically not block
</li>
<li class="fragment roll-in">Deferred, like everything else
</li>
<li class="fragment roll-in">Shared mutable state is crazy annoying to get right
<ul class="org-ul">
<li class="fragment roll-in">Passing in a <code>{}</code>: crude, awful hack
<ul class="org-ul">
<li>but Python guarantees <code>dict</code> operations are atomic&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Got shared mutable state?
<ul class="org-ul">
<li>Django is full of it
</li>
<li>Python modules are shared mutable state, too
</li>
</ul>
</li>
<li class="fragment roll-in">Consequence of threads, not <code>deferToThread</code>
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">5</span> Twisted in blocking code</h2>
</section>
<section>

<h3><span class="section-number-3">5.1</span> New hotness!</h3>
<p>
<code>itamarst/crochet</code>
</p>
</section>
<section>

<h3><span class="section-number-3">5.2</span> Setting it up</h3>
<p>
<code>from crochet import setup; setup()</code>
</p>

<ul class="org-ul">
<li class="fragment roll-in">Spawns a thread, runs the reactor in it
</li>
<li class="fragment roll-in">Makes <code>logging</code> magically work
</li>
<li class="fragment roll-in">Idempotent
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">5.3</span> Using it</h3>
<ul class="org-ul">
<li class="fragment roll-in"><code>@run_in_reactor</code>
<ul class="org-ul">
<li>Function runs in reactor thread, not calling thread
</li>
<li>Results in an <code>EventualResult</code>
</li>
</ul>
</li>
<li class="fragment roll-in"><code>EventualResult</code>?
<ul class="org-ul">
<li>Synchronous analog of <code>Deferred</code>
</li>
<li><code>wait(timeout=None)</code>
</li>
<li><code>cancel()</code>, <code>stash()</code>
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">5.4</span> Example</h3>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">from</span> twisted.web.client <span style="color: #7f007f;">import</span> getPage
<span style="color: #7f007f;">from</span> crochet <span style="color: #7f007f;">import</span> setup, run_in_reactor
setup()

<span style="color: #228b22;">@run_in_reactor</span>
<span style="color: #7f007f;">def</span> <span style="color: #0000ff;">download_page</span>(url):
    <span style="color: #7f007f;">return</span> getPage(url)

<span style="color: #a0522d;">result</span> = download_page(<span style="color: #8b2252;">"http://www.google.com"</span>)
<span style="color: #7f007f;">print</span> result.wait()
</pre>
</div>
</section>
<section>

<h3><span class="section-number-3">5.5</span> Longer example: exchange rates</h3>
<p>
Demo time!
</p>

<ul class="org-ul">
<li>Adapted version of a <code>crochet</code> demo
</li>
<li>Flask app serving current exchange rate
</li>
<li>Twisted regularly downloads new value in the background
</li>
</ul>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">6</span> Twisted in Gevent</h2>
</section>
<section>

<h3><span class="section-number-3">6.1</span> Water and fire, but it works</h3>
<p>
<code>jyio/geventreactor</code>
</p>

<ul class="org-ul">
<li class="fragment roll-in">Just another reactor backend for Twisted
<ul class="org-ul">
<li class="fragment roll-in">Not a huge gross hack ☺
</li>
</ul>
</li>
<li class="fragment roll-in">You can use "blocking code" in a lot of places
<ul class="org-ul">
<li class="fragment roll-in">That means "code <code>gevent</code> can make non-blocking"
</li>
<li class="fragment roll-in">Blocking the reactor greenlet: still not okay
</li>
<li class="fragment roll-in">Earlier <code>requests.get</code> example: probably okay
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">6.2</span> Components</h3>
<ul class="org-ul">
<li class="fragment roll-in"><code>GeventReactor</code>
<ul class="org-ul">
<li><code>import geventreactor; geventreactor.install()</code>
</li>
</ul>
</li>
<li class="fragment roll-in"><code>GeventThreadPool</code>
<ul class="org-ul">
<li>Like Twisted's thread pools
</li>
<li>Except greenlets, not actually threads
</li>
</ul>
</li>
<li class="fragment roll-in"><code>GeventResolver</code>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">6.3</span> Bi-directional bridge</h3>
<ul class="org-ul">
<li class="fragment roll-in"><code>waitForDeferred</code>: "blocks" until Deferred fires
<div class="org-src-container">

<pre class="src src-python"><span style="color: #a0522d;">result</span> = waitForDeferred(getPage(url))
</pre>
</div>
</li>
<li class="fragment roll-in"><code>waitForGreenlet</code>: greenlet → Deferred
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">return</span> waitForGreenlet(Greenlet.spawn(f, *a, **kw))
</pre>
</div>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">6.4</span> Demo time</h3>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">7</span> Recap</h2>
</section>
<section>

<h3><span class="section-number-3">7.1</span> Twisted plays well with others</h3>
<ul class="org-ul">
<li class="fragment roll-in">It supports many protocols
<ul class="org-ul">
<li>JSON-RPC, XML-RPC, HTTP/REST, AMP, whatever
</li>
<li>It will serve your WSGI apps
</li>
</ul>
</li>
<li class="fragment roll-in">It will work side by side with existing blocking code
</li>
<li class="fragment roll-in">It can have blocking code added to it later
</li>
<li class="fragment roll-in">It will cooperate with most existing event loops
<ul class="org-ul">
<li class="fragment roll-in">Gevent, <code>libev(ent)</code>, CoreFoundation&#x2026;
</li>
<li class="fragment roll-in">GUIs, like GTK, Qt&#x2026;
</li>
<li class="fragment roll-in">ZeroMQ (but please don't use ZeroMQ)
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Many analogs for things you already know are available
<ul class="org-ul">
<li class="fragment roll-in"><code>treq</code> is like <code>requests</code>
</li>
<li class="fragment roll-in"><code>klein</code> is like Flask
</li>
<li class="fragment roll-in"><code>cyclone</code> is Tornado on top of Twisted's reactor
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
</ul>
</section>
<section>

<h3><span class="section-number-3">7.2</span> Conclusion</h3>
<ul class="org-ul">
<li class="fragment roll-in">If you want to use Twisted, you probably can
</li>
<li class="fragment roll-in">That doesn't mean it's a good idea
<ul class="org-ul">
<li class="fragment roll-in">&#x2026; although it probably is ;-)
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section>

<h2><span class="section-number-2">8</span> Questions?</h2>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.min.js"></script>
<script>

        		// Full list of configuration options available here:
        		// https://github.com/hakimel/reveal.js#configuration
        		Reveal.initialize({
        			controls: true,
        			progress: true,
        			history: true,
        			center: true,

        			theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        			transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

        			// Optional libraries used to extend on reveal.js
        			dependencies: [
        				{ src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
        				{ src: './reveal.js/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        				{ src: './reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        				{ src: './reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        				{ src: './reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
        				{ src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        				// { src: './reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
        				// { src: './reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        			]
        		});
</script>
</body>
</html>
