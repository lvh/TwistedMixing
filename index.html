<?xml version="1.0" encoding="utf-8"?>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><title>(Twisted Mixing)</title>
<meta name="author" content="(Laurens Van Houtven)"/>
<link rel="stylesheet" href="./reveal.js/css/reveal.min.css">
<link rel="stylesheet" href="./reveal.js/css/theme/lvh.css" id="theme">

<link rel="stylesheet" href="./reveal.js/css/print/pdf.css" type="text/css" media="print">
</head>
<body>
<div class="reveal">
<div class="slides">
<section>
<h1>Twisted Mixing</h1>
<h2>Laurens Van Houtven</h2>
<h2><a href="mailto:@lvh">@lvh</a></h2>
<h2></h2></section>

<section>
<section id="sec-1" >

<h2>Introduction</h2>
</section>
<section id="sec-1-1" >

<h3>About me</h3>
<p>
Hi, I'm <code>lvh</code>.
</p>

<p>
I hack on and with Twisted.
</p>
</section>
<section id="sec-1-2" >

<h3>Rackspace</h3>

<div class="figure">
<p><img src="./media/rackspace.svg" style="border:none" alt="rackspace.svg"/></p>
</div>
</section>
<section id="sec-1-3" >

<h3>About this talk</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted code ↔ other code
</li>
<li class="fragment roll-in">Show that you probably <b>can</b> use Twisted
<ul class="org-ul">
<li>(Not so much that you <b>should</b> use Twisted)
</li>
</ul>
</li>
<li class="fragment roll-in">Overview
</li>
</ul>
</section>
<section id="sec-1-4" >

<h3>Why should you care?</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted has some cool stuff in and around it
<ul class="org-ul">
<li class="fragment roll-in">IRC, SMTP, DNS, SSH, WebSockets&#x2026;
</li>
<li class="fragment roll-in">Running multiple things in one process
</li>
<li class="fragment roll-in">Timed events, sane process and thread management
</li>
<li class="fragment roll-in">Protocol and transport abstractions
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Twisted vs other stuff: good at different things
<ul class="org-ul">
<li class="fragment roll-in">Many connections, particularly if relatively silent
<ul class="org-ul">
<li>Incoming, e.g. a chat server
</li>
<li>Outgoing, e.g. a scraper
</li>
</ul>
</li>
</ul>
<ul class="org-ul">
<li class="fragment roll-in">Cooperate with existing event loops
<ul class="org-ul">
<li>GUIs
</li>
<li>gevent
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-1-5" >

<h3>Prerequisites</h3>
<ul class="org-ul">
<li class="fragment roll-in">Ideally, just Python
</li>
<li class="fragment roll-in">Having played with Twisted probably helps
</li>
<li class="fragment roll-in">I will explain important concepts briefly
<ul class="org-ul">
<li>Please feel free to interrupt if I forget to
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section id="sec-2" >

<h2>Introducing Twisted</h2>
</section>
<section id="sec-2-1" >

<h3>Reactor</h3>
<p>
An object that reacts to events
</p>

<aside class="notes">
   You register events, it waits for them, and dispatches when they happen
   Internally: event loop, except for test reactors e.g. =Clock=
</aside>
</section>
<section id="sec-2-2" >

<h3>Reactor interfaces</h3>
<p>
Usually you call higher-level APIs!
</p>

<ul class="org-ul">
<li class="fragment roll-in"><code>IReactorBase</code>: <code>run</code>, <code>stop</code>&#x2026;
</li>
<li class="fragment roll-in"><code>IReactorTime</code>: <code>callLater</code>&#x2026;
</li>
<li class="fragment roll-in"><code>IReactorProcess</code>: <code>spawnProcess</code>
</li>
<li class="fragment roll-in"><code>IReactorThreads</code>: <code>call(In|From)Thread</code>, &#x2026;
</li>
<li class="fragment roll-in"><code>IReactor(TCP|UDP|SSL|Multicast)</code>
</li>
<li class="fragment roll-in"><code>IReactor(UNIX|UNIXDatagram|Socket)</code>
</li>
<li class="fragment roll-in"><code>IReactorFDSet</code>: <code>(add|remove)(Reader|Writer)</code>, &#x2026;
</li>
</ul>
</section>
<section id="sec-2-3" >

<h3>Deferred</h3>
<p>
An object you get <b>now</b>,
</p>

<p>
gets you result or failure <b>later</b>
</p>
</section>
<section id="sec-2-4" >

<h3>Why deferreds?</h3>
<ul class="org-ul">
<li class="fragment roll-in">Many operations take time: <b>can't</b> get a result right now
</li>
<li class="fragment roll-in">Blocking API
<ul class="org-ul">
<li>Evaluate or raise some point in the future
</li>
<li>Thread can't do anything else in the mean while
</li>
</ul>
</li>
<li class="fragment roll-in">Deferred API
<ul class="org-ul">
<li>Get an object representing the future result <b>now</b>
</li>
<li>Actually give result (or failure) when it's available
</li>
<li>Thread is free to do something else
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-2-5" >

<h3>Deferred vs blocking API</h3>
<p>
Blocking read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = blocking_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>

<p>
Deferred read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #a0522d;">d</span> = async_read()
d.addCallbacks(on_result, on_failure)
</pre>
</div>
</section>
<section id="sec-2-6" >

<h3>Inline callbacks vs blocking API</h3>
<p>
Blocking read:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = blocking_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>

<p>
<code>inlineCallbacks</code>: Deferreds + sugar
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">try</span>:
    <span style="color: #a0522d;">result</span> = <span style="color: #7f007f;">yield</span> async_read()
    on_result(result)
<span style="color: #7f007f;">except</span> SomeError <span style="color: #7f007f;">as</span> e:
    on_failure(e)
</pre>
</div>
</section>
</section>
<section>
<section id="sec-3" >

<h2>Twisted and your app</h2>
</section>
<section id="sec-3-1" >

<h3>Is there even a problem?</h3>
<p>
Maybe it's trivial to get started!
</p>
</section>
<section id="sec-3-2" >

<h3>SOA</h3>
<p>
Service Oriented Architecture
</p>

<aside class="notes">
   * "Loosely coupled things that talk to each other"
   * Written in Gevent? Twisted? COBOL? Who cares!?
   * Work with Twisted, without touching existing code
</aside>
</section>
<section id="sec-3-3" >

<h3>WSGI</h3>
<p>
Web Server Gateway Interface
</p>

<p class="fragment roll-in">
<code>twistd web --wsgi=location.of.wsgi.app</code>
</p>

<aside class="notes">
   Show of hands: how many of you:
   * have a WSGI application?
   * knew Twisted has a production quality WSGI server?
</aside>
</section>
<section id="sec-3-4" >

<h3>Porting your app to Twisted</h3>
<ul class="org-ul">
<li class="fragment roll-in">No, it's not trivial
<ul class="org-ul">
<li>&#x2026; but cost is almost always overestimated
</li>
</ul>
</li>
<li class="fragment roll-in">Clean, tested code helps
<ul class="org-ul">
<li>Keep verifying behavior
</li>
<li>Tested code tends to be decoupled
</li>
</ul>
</li>
<li class="fragment roll-in">If it's near impossible, it's probably a code smell
</li>
</ul>
</section>
<section id="sec-3-5" >

<h3>Writing code that works on both</h3>
<ul class="org-ul">
<li>Not trivial, not hard either
</li>
<li>Example: <code>praekelt/vumi</code>
</li>
<li>TODO: more examples
</li>
</ul>
</section>
<section id="sec-3-6" >

<h3>Demo</h3>
<ul class="org-ul">
<li>Flask app, served by <code>t.w.wsgi</code>
</li>
<li>Real-time chat, with <code>txsockjs</code>
</li>
</ul>

<p>
<a href="media/twistyflask-tox-run.mp4">Test run</a>, <a href="media/twistyflask-demo.mp4">demo</a>
</p>
</section>
</section>
<section>
<section id="sec-4" >

<h2>Blocking code in Twisted</h2>
</section>
<section id="sec-4-1" >

<h3>You can't block the reactor thread</h3>
<ul class="org-ul">
<li class="fragment roll-in">Twisted is event-driven
<ul class="org-ul">
<li>Production reactors are just event loops
</li>
<li><code>select</code>, <code>epoll</code>, <code>kqueue</code>, IOCP, <code>libev(ent)</code>&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Reactor runs in a thread, calls everything else
<ul class="org-ul">
<li>One thing at a time, all in the same thread
</li>
<li>Concurrency through asynchronous IO
</li>
</ul>
</li>
<li class="fragment roll-in">Blocking the reactor thread means nothing else happens
</li>
</ul>
</section>
<section id="sec-4-2" >

<h3>Blocking in a callback is bad!</h3>
<p>
Blocking IO
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_getDataAtURL</span>(url):
    <span style="color: #7f007f;">return</span> requests.get(url).json() <span style="color: #b22222;"># </span><span style="color: #b22222;">BLOCKS!</span>
</pre>
</div>

<p>
Blocking computation
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_compute</span>(n):
    <span style="color: #a0522d;">x</span> = 2
    <span style="color: #7f007f;">for</span> _ <span style="color: #7f007f;">in</span> <span style="color: #483d8b;">xrange</span>(n): <span style="color: #b22222;"># </span><span style="color: #b22222;">BLOCKS! (for large n)</span>
        <span style="color: #a0522d;">x</span> *= x
    send_somewhere(x)
</pre>
</div>
</section>
<section id="sec-4-3" >

<h3>Can't block the reactor thread!</h3>
<p>
Therefore, you have two options:
</p>

<ol class="org-ol">
<li>Don't block
</li>
<li>Block another thread
</li>
</ol>
</section>
<section id="sec-4-4" >

<h3>Don't block</h3>
<p>
IO bound? Be asynchronous!
</p>

<p>
CPU bound? Cooperate with the event loop!
</p>
</section>
<section id="sec-4-5" >

<h3>Asynchronous I/O version</h3>
<p>
<code>treq</code>: <code>requests</code>-like, but asynchronous
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_getDataAtURL</span>(url):
    <span style="color: #a0522d;">d</span> = treq.get(url)
    d.addCallback(treq.json_content)
    <span style="color: #7f007f;">return</span> d
</pre>
</div>
</section>
<section id="sec-4-6" >

<h3>Cooperative version</h3>
<p>
<code>twisted.internet.task.coiterate</code> and friends
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_compute</span>(n):
    <span style="color: #a0522d;">x</span> = 2
    <span style="color: #7f007f;">for</span> _ <span style="color: #7f007f;">in</span> <span style="color: #483d8b;">xrange</span>(n):
        <span style="color: #a0522d;">x</span> *= x
        <span style="color: #7f007f;">yield</span> <span style="color: #b22222;"># </span><span style="color: #b22222;">Yields to the reactor :)</span>
    send_somewhere(x)

coiterate(_compute(n))
</pre>
</div>
</section>
<section id="sec-4-7" >

<h3>Don't block?</h3>
<p>
Avoiding blocking isn't always possible
</p>

<ul class="org-ul">
<li class="fragment roll-in">Blocking API
<ul class="org-ul">
<li><code>DBAPI2</code>, &#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Sometimes in C code you can't or don't want to mess with
<ul class="org-ul">
<li><code>scrypt</code>, &#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Sometimes at a kernel/syscall level
<ul class="org-ul">
<li>File IO, &#x2026;
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-4-8" >

<h3>Block somewhere else</h3>
<p>
Can't block the reactor thread → block a different one!
</p>

<ul class="org-ul">
<li class="fragment roll-in">&#x2026; in the same process: <code>deferToThread</code>
<ul class="org-ul">
<li>often used by wrappers: <code>adbapi</code>, <code>txscrypt</code>&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">&#x2026; in a child process: <code>spawnProcess</code> and friends
</li>
<li class="fragment roll-in">&#x2026; in a remote process: Ampoule, PB, Foolscap, RPC&#x2026;
</li>
</ul>
</section>
<section id="sec-4-9" >

<h3>deferToThread</h3>
<ul class="org-ul">
<li class="fragment roll-in">Easy automagic deferreds!
</li>
<li class="fragment roll-in">Shared mutable state ☹
</li>
</ul>

<aside class="notes">
     * Passing in a ={}=: crude, awful hack, but Python guarantees
       =dict= operations are atomic...
     * Many projects full of shared mutable state; Python module
       system!
     * Consequence of threads, not =deferToThread=
</aside>
</section>
</section>
<section>
<section id="sec-5" >

<h2>Twisted in blocking code</h2>
</section>
<section id="sec-5-1" >

<h3>New hotness!</h3>
<p>
<code>itamarst/crochet</code>
</p>
</section>
<section id="sec-5-2" >

<h3>Setting it up</h3>
<p>
<code>from crochet import setup</code>
</p>

<p>
<code>setup()</code>
</p>

<aside class="notes">
   * Spawns a thread, runs the reactor in it
   * Idempotent
   * Makes =logging= magically work
</aside>
</section>
<section id="sec-5-3" >

<h3>Using it</h3>
<ul class="org-ul">
<li class="fragment roll-in"><code>@run_in_reactor</code>
<ul class="org-ul">
<li>Function runs in reactor thread, not calling thread
</li>
<li>Results in an <code>EventualResult</code>
</li>
</ul>
</li>
<li class="fragment roll-in"><code>EventualResult</code>?
<ul class="org-ul">
<li>Synchronous analog of <code>Deferred</code>
</li>
<li><code>wait(timeout=None)</code>
</li>
<li><code>cancel()</code>, <code>stash()</code>
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-5-4" >

<h3>Example</h3>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">from</span> twisted.web.client <span style="color: #7f007f;">import</span> getPage
<span style="color: #7f007f;">from</span> crochet <span style="color: #7f007f;">import</span> setup, run_in_reactor
setup()

<span style="color: #228b22;">@run_in_reactor</span>
<span style="color: #7f007f;">def</span> <span style="color: #0000ff;">download_page</span>(url):
    <span style="color: #7f007f;">return</span> getPage(url)

<span style="color: #a0522d;">result</span> = download_page(<span style="color: #8b2252;">"http://www.google.com"</span>)
<span style="color: #7f007f;">print</span> result.wait()
</pre>
</div>
</section>
<section id="sec-5-5" >

<h3>Longer example: exchange rates</h3>
<ul class="org-ul">
<li>Twisted queries exchange rate every 30s
<ul class="org-ul">
<li>Runs in a separate thread using <code>crochet</code>
</li>
</ul>
</li>
<li>Flask app serves the latest exchange rate
</li>
</ul>

<p>
<a href="media/twistycrochet-demo.mp4">Demo</a>
</p>
</section>
<section id="sec-5-6" >

<h3>How does it work? Twisted part</h3>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #7f007f;">class</span> <span style="color: #228b22;">ExchangeRate</span>(<span style="color: #483d8b;">object</span>):
    <span style="color: #b22222;"># </span><span style="color: #b22222;">...</span>

    <span style="color: #228b22;">@run_in_reactor</span>
    <span style="color: #7f007f;">def</span> <span style="color: #0000ff;">start</span>(<span style="color: #7f007f;">self</span>):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">in reactor thread because of decorator</span>
        <span style="color: #7f007f;">self</span>._lc = LoopingCall(<span style="color: #7f007f;">self</span>._download)
        <span style="color: #7f007f;">self</span>._lc.start(30, now=<span style="color: #008b8b;">True</span>)

    <span style="color: #7f007f;">def</span> <span style="color: #0000ff;">_download</span>(<span style="color: #7f007f;">self</span>):
        <span style="color: #b22222;"># </span><span style="color: #b22222;">in reactor thread because of LoopingCall</span>
        <span style="color: #a0522d;">d</span> = getPage(url)
        <span style="color: #b22222;"># </span><span style="color: #b22222;">...</span>
</pre>
</div>

<p>
Twisted code looks like regular Twisted code!
</p>

<p>
(But remember the <code>@run_in_reactor</code>)
</p>
</section>
<section id="sec-5-7" >

<h3>How does it work? Flask part</h3>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #228b22;">@app.route</span>(<span style="color: #8b2252;">'/'</span>)
<span style="color: #7f007f;">def</span> <span style="color: #0000ff;">index</span>():
    <span style="color: #b22222;"># </span><span style="color: #b22222;">runs in whatever thread app.run() runs it in</span>
    <span style="color: #a0522d;">rate</span> = EURUSD.latest_value()
    <span style="color: #7f007f;">if</span> rate <span style="color: #7f007f;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #a0522d;">rate</span> = <span style="color: #8b2252;">"unavailable"</span>
    <span style="color: #7f007f;">return</span> <span style="color: #8b2252;">"EUR/USD rate: {0}."</span>.<span style="color: #483d8b;">format</span>(rate)

app.run()
</pre>
</div>

<p>
Flask code looks like regular Flask code!
</p>
</section>
</section>
<section>
<section id="sec-6" >

<h2>Twisted in Gevent</h2>
</section>
<section id="sec-6-1" >

<h3>Water and fire, but it works</h3>
<p>
<code>jyio/geventreactor</code>
</p>
</section>
<section id="sec-6-2" >

<h3>Setting it up</h3>
<p>
<code>import geventreactor</code>
</p>

<p>
<code>geventreactor.install()</code>
</p>
</section>
<section id="sec-6-3" >

<h3>"Blocking" code</h3>
<ul class="org-ul">
<li>Gevent-style "blocking", i.e.  automagic suspending
</li>
</ul>
<ul class="org-ul">
<li class="fragment roll-in">Supported in most places
<ul class="org-ul">
<li class="fragment roll-in">Suspending the reactor greenlet: bad
</li>
<li class="fragment roll-in">Actually blocking anything: bad
</li>
<li class="fragment roll-in">Earlier <code>requests.get</code> example: probably okay
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-6-4" >

<h3>Deferreds ↔ greenlets</h3>
<p>
<code>r = waitForDeferred(d)</code>
</p>

<p>
<code>d = waitForGreenlet(g)</code>
</p>
</section>
<section id="sec-6-5" >

<h3>Demo</h3>
<p>
TODO
</p>
</section>
</section>
<section>
<section id="sec-7" >

<h2>Recap</h2>
</section>
<section id="sec-7-1" >

<h3>Twisted plays well with others</h3>
<ul class="org-ul">
<li class="fragment roll-in">It supports many protocols
<ul class="org-ul">
<li>JSON-RPC, XML-RPC, HTTP/REST, AMP, whatever
</li>
<li>It will serve your WSGI apps
</li>
</ul>
</li>
<li class="fragment roll-in">It will work side by side with existing blocking code
</li>
<li class="fragment roll-in">It can have blocking code added to it later
</li>
<li class="fragment roll-in">It will cooperate with most existing event loops
<ul class="org-ul">
<li class="fragment roll-in">Gevent, <code>libev(ent)</code>, CoreFoundation&#x2026;
</li>
<li class="fragment roll-in">GUIs, like GTK, Qt&#x2026;
</li>
<li class="fragment roll-in">ZeroMQ (but please don't use ZeroMQ)
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
<li class="fragment roll-in">Many analogs for things you already know are available
<ul class="org-ul">
<li class="fragment roll-in"><code>treq</code> is like <code>requests</code>
</li>
<li class="fragment roll-in"><code>klein</code> is like Flask
</li>
<li class="fragment roll-in"><code>cyclone</code> is Tornado on top of Twisted's reactor
</li>
<li class="fragment roll-in">&#x2026;
</li>
</ul>
</li>
</ul>
</section>
<section id="sec-7-2" >

<h3>Conclusion</h3>
<ul class="org-ul">
<li class="fragment roll-in">If you want to use Twisted, you probably can
</li>
<li class="fragment roll-in">That doesn't mean it's a good idea
<ul class="org-ul">
<li class="fragment roll-in">&#x2026; although it probably is ;-)
</li>
</ul>
</li>
</ul>
</section>
</section>
<section>
<section id="sec-8" >

<h2>Questions?</h2>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.min.js"></script>
<script>

        		// Full list of configuration options available here:
        		// https://github.com/hakimel/reveal.js#configuration
        		Reveal.initialize({
        			controls: true,
        			progress: true,
        			history: true,
        			center: true,
        			rollingLinks: false,
        			keyboard: true,
        			overview: true,
        			 // slide width
        			 // slide height
        			 // slide margin
        			 // slide minimum scaling factor
        			 // slide maximum scaling factor


        			theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        			transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
        			transitionSpeed: 'default',

        			// Optional libraries used to extend on reveal.js
        			dependencies: [
        				{ src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
        				{ src: './reveal.js/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        				{ src: './reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        				{ src: './reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        				{ src: './reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
        				{ src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        				// { src: './reveal.js/plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
        				// { src: './reveal.js/plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        			]
        		});
</script>
</body>
</html>
